
<html>
<head>

<title>sms</title>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/>
<link rel="stylesheet" href="app/css/default.css">
<style>
   td {
    text-align: center; 
   }
   th {
    text-align: center; 
   }
</style>

</head>
<body>

<div style='overflow: auto; height: 100%; width: 100%;'>
<table border='0' cellpadding='4' cellspacing='0' style='width: 100%; font-size: 14px; border: 1px solid black;'>
<tr><th>№</th><th>Имя</th><th>Номера</th><th>Сообщение</th><th>Дата</th><th>Время</th><th></th></tr>


<bsh>
// Enter code here...

import org.json.*;
import android.net.Uri;
import android.provider.Contacts.People;
import android.provider.Contacts.Phones;
import java.text.DateFormat;
import java.util.ArrayList;
import java.util.*;
import java.text.SimpleDateFormat;
c = Calendar.getInstance();

d = new SimpleDateFormat("dd-MM-yyyy");
t = new SimpleDateFormat("HH:mm:ss");
date_now = d.format(c.getTime());
time_now = t.format(c.getTime());

arr = new ArrayList<Integer>();
sms = new JSONObject();
total = new JSONObject();

incoming=0;
outgoing=0;
draft = 0;
new_sms=0;

send = parameters.get("send");
text = parameters.get("date");

service = server.props.get("serviceContext");

SMS_CONTENT_URI = Uri.parse("content://sms");
cursor = service.getContentResolver().query(SMS_CONTENT_URI,
    new String[] { "_id", "thread_id", "address", "person", "date", "body", "status", "type", "read"}, null, null, "date DESC");

numberold=0;
smsCount = 0;

if (cursor != null) {
    try {
        smsCount = cursor.getCount();
		colour = "#eaeaea";
		//print(text);
        if (cursor.moveToFirst()) {
            do {
				colour = colour.equals("#eaeaea") ? "white" : "#eaeaea";
				position = cursor.getPosition();
				
                messageId = cursor.getLong(0);
                threadId = cursor.getLong(1);
				address= cursor.getString(2);
				contactId = cursor.getInt(3);
                timestamp = cursor.getLong(4);
                body = cursor.getString(5);
                status = cursor.getInt(6);
				type =  cursor.getInt(7);
				read = cursor.getInt(8);
				
				date = d.format(timestamp);
				time = t.format(timestamp);

			  // поиск контакта
                if(address != null) {
                    name = null;
					phones = service.getContentResolver().query(android.provider.ContactsContract.CommonDataKinds.Phone.CONTENT_URI, new String[] { android.provider.ContactsContract.CommonDataKinds.Phone.RAW_CONTACT_ID }, android.provider.ContactsContract.CommonDataKinds.Phone.NUMBER + "=?", new String[] { address }, null);
                    if(phones.moveToFirst()) {
                        contactId = phones.getInt(0);
                    }
                    phones.close();
                    contact = service.getContentResolver().query(
                        android.provider.ContactsContract.Data.CONTENT_URI, new String[] {android.provider.ContactsContract.CommonDataKinds.StructuredName.DISPLAY_NAME }, android.provider.ContactsContract.Data.RAW_CONTACT_ID + "=? AND " + android.provider.ContactsContract.CommonDataKinds.StructuredName.MIMETYPE + "=?", new String[] { "" + contactId, android.provider.ContactsContract.CommonDataKinds.StructuredName.CONTENT_ITEM_TYPE }, null);
                    if(contact.moveToFirst()) {
                        name = contact.getString(0);
                    }
                    contact.close();
				}else{
					name = null;
				}
									
					if (name == null) {
						name = "null";
					}
					

					switch(type) {
						case 1:
						type = "incoming";
						incoming = incoming + 1;
						break;
						case 2:
						type = "outgoing";
						outgoing = outgoing + 1;
						break;
						case 3:
						type = "draft";
						draft = draft + 1;
						break;
					}
					
					if(read==0){
						new_sms=new_sms+1;
						}
							
					sms.put("Id", messageId);
					sms.put("threadId", threadId);
					sms.put("number", address);
					sms.put("timestamp", timestamp);
					sms.put("date", date);
					sms.put("time", time);
					sms.put("body", body);
					//sms.put("count", count);
					sms.put("read", read);
					sms.put("type", type);
					sms.put("name", name);
					
					
				

					if(send!=null){
						switch(send) {
							case "now":
								if(date_now.equals(date)){
									arr.add(sms);
									print(send);
								}
							break;
							case "all":
							if(text!=null){
								if(text.equals(date)){
									arr.add(sms);
							}
							}else{
								arr.add(sms);
							}	
							break;
							case "incoming":
							if(type=="incoming"){
								if(text!=null){
									if(text.equals(date)){
										arr.add(sms);
									}
								}else{
									arr.add(sms);
								}
							}	
							break;
							case "outgoing":
							if(type=="outgoing"){
								if(text!=null){
									if(text.equals(date)){
										arr.add(sms);
									}
								}else{
									arr.add(sms);
								}
							}	
							break;
						}
						//print(date_now.equals(date));

					}else{
						
						callImage = "";
						callTypeLabel = "";
						switch(type) {
							case "incoming":
							callImage = "app/images/call_incoming.png";
							//callTypeLabel = translateRaw("tooltip.phone_incoming");
							break;
							case "outgoing":
							callImage = "app/images/call_outgoing.png";
							//callTypeLabel = translateRaw("tooltip.phone_outgoing");
							break;
							case "draft":
							callImage = "app/images/stop.png";
							
							//callTypeLabel = translateRaw("tooltip.phone_missed");
							break;
							
						}
						
						if(read==0){
								read = "<img src='app/images/mail.png' style='width: 16px;' >";
							}else{
								read = "";
							}
						
						if(!name.equals("null")) {
							//phoneLink = "<a href='app/dial.xhtml?number=" + URLEncoder.encode(callNumber) + "' style='color: black;' class='link'>" + (callName != "null" ? callName : callNumber)  + "</a>";
							phoneLink = name;
						}else {
							phoneLink = "Unknown";
							}
							print("<tr style='background:"+colour+";'><td style='width: 50px; text-align:right;'>"+ ++position+"&nbsp;<img src='" + callImage + "'style='width: 16px;'  xalign='middle' title='" + callTypeLabel + "'></td><td style='width: 10%;'>" + phoneLink  + "</td><td style='width: 10%; color: black;'>"+address+"</td><td style='width: 40%; color: black;'>"+body+"</td><td style='color: black;'>"+date+"</td><td style='color: black;'>"+time+"</td><td style='color: black; width: 5%;'>" + read + "</td></tr>");
					}	
			
			//print("проверка");
			
				sms = "";
				sms = new JSONObject();
			
			
			
			
			
			
			
			
			
			
			
                
            } while(cursor.moveToNext());
        }
    }
    finally {
        cursor.close();
    }
}


total.put("all", smsCount);
total.put("draft", draft);
total.put("outgoing", outgoing);
total.put("incoming", incoming);
total.put("new_sms", new_sms);

if(send.equals("info")){
sand_date=total;	
}else{
sand_date=arr;
}



if(send!=null){
request.sendResponse(sand_date.toString().getBytes(), "text/plain; charset=UTF-8");
request.out.flush();
request.out.close();	
	
}else{
	print("</table></div>");
}


</bsh>
</body>
</html>
